# –ú–æ–¥—É–ª—å 4: Device Service

## –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ device-service
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç CRUD API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- –ß–∏—Ç–∞–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL,
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —à–∞—Ä–¥–∞–º–∏,
- –≠–∫—Å–ø–æ–Ω–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏, –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–æ–±–Ω—É—é —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é.
- –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∑–∞—â–∏—â–µ–Ω—ã OIDC (JWT) —á–µ—Ä–µ–∑ Keycloak (–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ, –¥–æ—Å—Ç—É–ø –ø–æ —Ä–æ–ª—è–º.)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à Redis (read-through —Å—Ç—Ä–∞—Ç–µ–≥–∏—è) –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º.

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —à–∞—Ä–¥–∏–Ω–≥–∞
### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ resources:  
- üìÑ[`sharding.yaml`](./src/main/resources/sharding.yaml)

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã
–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É —à–∞—Ä–¥–∞–º–∏ –ø–æ —Ö–µ—à—É device_id
- –§–æ—Ä–º—É–ª–∞: ``` target_shard = abs(device_id.hashCode()) % 2 ‚Üí ds_0 –∏–ª–∏ ds_1 ```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –í—Å–µ —à–∞—Ä–¥—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü
- –ó–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É—é—Ç—Å—è –∫ –Ω—É–∂–Ω–æ–º—É —à–∞—Ä–¥—É
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ —à–∞—Ä–¥–∞

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- Flyway-–º–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–æ—á–µ—Ä–µ–¥–Ω–æ –∫ –∫–∞–∂–¥–æ–π –±–∞–∑–µ –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–æ—Ñ–∏–ª–∏ –≤  üìÑ[`application.yaml`](./src/main/resources/application.yaml)
- –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ [migration](./src/main/resources/db/migration)

## –î–∏–∞–≥—Ä–∞–º–º—ã
### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ C4 –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ [diagrams](diagrams):

- üìÑ[`container`](./diagrams/container.puml)
- üìÑ[`context`](./diagrams/context.puml)
- üìÑ[`sequence`](./diagrams/sequence.puml)
- üìÑ[`sequence`](./diagrams/component.puml)

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É:
- –ó–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã: –∏–∑ –∫–æ—Ä–Ω—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å docker-compose up -d
- –ó–∞–ø—É—Å–∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞: docker-compose -f device-service/docker-compose.yml up -d
- –°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å –ø–æ—Ä—Ç 9993

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
- –Ø–∑—ã–∫: Java 21
- –§—Ä–µ–π–º–≤–æ—Ä–∫–∏: Spring Boot 3.5.3, Spring Web MVC, Spring Data JPA, Spring Boot Actuator, Spring Data Redis, 
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:  PostgreSQL
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: Spring Security, Keycloak Spring Boot Starter 25.0.3, Keycloak Admin Client 26.0.2
- –¢—Ä–µ–π—Å—ã: OpenTelemetry Spring Boot Starter 2.11.0
- –õ–æ–≥–∏: Loki4j Logback Appender 1.4.2
- –®–∞—Ä–¥–∏–Ω–≥: Apache ShardingSphere JDBC 5.5.2
- –ú–∏–≥—Ä–∞—Ü–∏–∏: Flyway Core + Flyway PostgreSQL
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: Micrometer + Prometheus (—á–µ—Ä–µ–∑ micrometer-registry-prometheus)
- –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è: Avro (–¥–ª—è Kafka —Å–æ–æ–±—â–µ–Ω–∏–π) + –ø–ª–∞–≥–∏–Ω
- –£—Ç–∏–ª–∏—Ç—ã: Lombok 1.18.30, MapStruct 1.6.3
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: Testcontainers (Kafka, PostgreSQL), Spring Boot Test, Spring Kafka Test, JUnit 5 (Jupiter)
- –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: Spring Testcontainers, JUnit 5