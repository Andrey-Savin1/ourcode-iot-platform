# –ú–æ–¥—É–ª—å 2: Device Collector

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞:

- device-collector-service - –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

## –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ Kafka –≤ —Ñ–æ—Ä–º–∞—Ç–µ Avro (–≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Schema Registry)
- C–æ—Ö—Ä–∞–Ω—è–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –≤ PostgreSQL, –∏—Å–ø–æ–ª—å–∑—É—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Apache ShardingSphere
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- –û—Ç–∫–∏–¥—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∏ liveness/readiness —á–µ—Ä–µ–∑ Spring Actuator.

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —à–∞—Ä–¥–∏–Ω–≥–∞
### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ resources:  
- üìÑ[`sharding.yaml`](./src/main/resources/sharding.yaml)

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã
–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É —à–∞—Ä–¥–∞–º–∏ –ø–æ —Ö–µ—à—É device_id
- –§–æ—Ä–º—É–ª–∞: ``` target_shard = abs(device_id.hashCode()) % 2 ‚Üí ds_0 –∏–ª–∏ ds_1 ```


### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –í—Å–µ —à–∞—Ä–¥—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü
- –ó–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É—é—Ç—Å—è –∫ –Ω—É–∂–Ω–æ–º—É —à–∞—Ä–¥—É
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ —à–∞—Ä–¥–∞

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- Flyway-–º–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–æ—á–µ—Ä–µ–¥–Ω–æ –∫ –∫–∞–∂–¥–æ–π –±–∞–∑–µ –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–æ—Ñ–∏–ª–∏ –≤  üìÑ[`application.yaml`](./src/main/resources/application.yaml)
- –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ [migration](./src/main/resources/db/migration)

## –î–∏–∞–≥—Ä–∞–º–º—ã
### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ C4 –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ [diagrams](diagrams):

- üìÑ[`container`](./diagrams/container.puml)
- üìÑ[`context`](./diagrams/context.puml)
- üìÑ[`sequence`](./diagrams/sequence.puml)

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É:
- –ó–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã: –∏–∑ –∫–æ—Ä–Ω—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å docker-compose up -d
- –ó–∞–ø—É—Å–∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞: docker-compose -f device-collector-service/docker-compose.yml up -d
- –°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å –ø–æ—Ä—Ç 9992


## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
- –Ø–∑—ã–∫: Java 21
- –§—Ä–µ–π–º–≤–æ—Ä–∫–∏: Spring Boot 3.5.3, Spring Web MVC, Spring Data JPA, Spring Kafka, Spring Actuator, Spring Testcontainers
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:  PostgreSQL
- –®–∞—Ä–¥–∏–Ω–≥: Apache ShardingSphere JDBC 5.5.2
- –ú–∏–≥—Ä–∞—Ü–∏–∏: Flyway Core + Flyway PostgreSQL
- –†–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏: Apache Kafka, Apache Avro 1.12.0, Confluent Kafka Avro Serializer 7.8.1
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: Micrometer + Prometheus (—á–µ—Ä–µ–∑ micrometer-registry-prometheus)
- –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è: Avro (–¥–ª—è Kafka —Å–æ–æ–±—â–µ–Ω–∏–π) + –ø–ª–∞–≥–∏–Ω
- –£—Ç–∏–ª–∏—Ç—ã: Lombok 1.18.30, MapStruct 1.6.3
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: Testcontainers (Kafka, PostgreSQL), Spring Boot Test, Spring Kafka Test, JUnit 5 (Jupiter)
- –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: Spring Testcontainers, JUnit 5